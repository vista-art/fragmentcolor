<html>
  <video
    id="world_video"
    src="https://www.w3schools.com/html/world.mp4"
  ></video>
  <video id="eye_video" src="https://www.w3schools.com/html/eye.mp4"></video>
  <canvas width="1000" height="800" id="input-canvas"></canvas>
  <canvas width="600" height="400" id="output-canvas"></canvas>
  <script>
    eye_video = document.getElementById("eye_video");
    world_video = document.getElementById("world_video");

    video.addEventListener("timeupdate", function (e) {
      console.log("timeupdate");
    });
    video.addEventListener("seeked", function (e) {
      console.log("seeked");
    });
    function gaze_for_time(time) {
      // TODO: from react state later
      return {
        x: time * Math.sin(time),
        y: time * Math.cos(time),
      };
    }
    video.addEventListener("play", () => {
      var time = video.currentTime;
      console.log("time: " + time);
      function step() {
        gaze = gaze_for_time(time);
        circle.set_x(gaze.x);
        circle.set_y(gaze.y);
        // ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step); // TODO: how/will this work, do we need it even?
    });

    world_texture = context.add_texture(world_video);
    eye_texture = context.add_texture(eye_video);

    world_layer = context.layer();
    eye_layer = context.layer();
    gaze_layer = context.layer({
      distort: {
        camera_matrix: camera_matrix,
        distortion_matrix: distortion_matrix,
      },
    });

    world_image = world_layer.undistorted_image({
      texture: world_texture,
      camera_matrix: camera_matrix,
      distortion_matrix: distortion_matrix,
      border_mode: "remove_black_borders",
    });

    eye_image = eye_layer.image({
      texture: eye_texture,
      x: 0.5,
      y: 0,
      width: 0.1,
      height: 0.1,
    });

    combined_eye_gaze = gaze_layer.circle({
      x: 0,
      y: 0,
      color: "red",
    });
    left_eye_gaze = gaze_layer.circle({
      x: 0,
      y: 0,
      color: "green",
    });
    left_eye_gaze.hide();
    right_eye_gaze = gaze_layer.circle({
      x: 0,
      y: 0,
      color: "blue",
    });
    right_eye_gaze.hide();

    canvas = context.add_source(video);
    canvas = context.add_canvas_target({
      selector: "#output-canvas",
    });
    file = context.add_file_target({
      filename: "rendered.mp4",
      height: 1000,
      width: 800,
      bitrate: 1000000,
    });
    callback_target = context.add_callback_target((image_rgb: ArrayBuffer) => {
      console.log(image_rgb);
    });

    // abort
    // canplay
    // canplaythrough
    // durationchange
    // emptied
    // encrypted
    // ended
    // error
    // loadeddata
    // loadedmetadata
    // loadstart
    // pause
    // play
    // playing
    // progress
    // ratechange
    // seeked
    // seeking
    // stalled
    // suspend
    // timeupdate
    // volumechange
    // waiting
  </script>
</html>
